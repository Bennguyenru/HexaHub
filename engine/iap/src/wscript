#! /usr/bin/env python
import os, re
from waf_dynamo import apidoc_extract_task

def configure(conf):
    pass

def build(bld):
    embed_source = ''
    source = []

    source += ['iap_private.cpp']
    if bld.env.PLATFORM in ('armv7-darwin', 'arm64-darwin', 'x86_64-ios'):
        source += ['iap_ios.mm']
    elif re.match('.*?android', bld.env.PLATFORM):
        source += ['iap_android.cpp']

        classpath = ['%s/ext/share/java/android.jar' % bld.env.DYNAMO_HOME,
                     '%s/ext/share/java/in-app-purchasing-2.0.61.jar' % bld.env.DYNAMO_HOME, # amazon
                     '%s/share/java/gamesys_android.jar' % bld.env.DYNAMO_HOME]
        classpath = os.pathsep.join(classpath)

        bld.new_task_gen(features='javac seq',
                         classpath=classpath,
                         source_root='java')

        bld.env["JAVACFLAGS"] = '-g -source 1.7 -target 1.7'

        bld.new_task_gen(features='jar seq dex',
                         basedir='java',
                         destfile='iap_android.jar')

        bld.install_files('${PREFIX}/share/java', 'iap_android.jar')
    elif 'web' in bld.env.PLATFORM:
        bld.install_files('${PREFIX}/lib/%s/js' % bld.env.PLATFORM, '../src/js/library_facebook_iap.js', postpone = False)
        source += ['iap_emscripten.cpp']
    else:
        source = ['iap_null.cpp']

    apidoc_extract_task(bld, ['iap_ios.mm'])

    iap = bld.new_task_gen(features = 'cxx cstaticlib embed',
                           includes = '.',
                           source = source,
                           target = 'iapext')
